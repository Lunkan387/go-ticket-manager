<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Statistiques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    html, body { height: 100%; }
    body { display: flex; flex-direction: column; }
    main { flex: 1; }
    .stat-value { font-size: 2rem; font-weight: 700; }
    .card-hover:hover { transform: translateY(-2px); transition: .15s ease; }
    .chart-container { position: relative; height: 360px; }
  </style>
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/home">Go Ticket Manager</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/home">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="/register">S'inscrire</a></li>
          <li class="nav-item"><a class="nav-link" href="/form">Form</a></li>
          <li class="nav-item"><a class="nav-link" href="/tickets">Tickets</a></li>
          <li class="nav-item"><a class="nav-link active" href="/supervisor">Supervision</a></li>
          <li class="nav-item"><a class="nav-link" href="/admin">Administration</a></li>
          <li class="nav-item"><a class="nav-link active" href="/stats">Statistiques</a></li>
          <li class="nav-item"><a class="nav-link text-warning fw-bold" href="/logout">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <main>
    <div class="container my-4">
      <h1 class="text-center fw-bold mb-4">üìä Statistiques</h1>

      <!-- R√©sum√© -->
      <section class="mb-4">
        <div class="row g-3">
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm card-hover h-100">
              <div class="card-body">
                <h5 class="card-title text-muted mb-1">Total tickets</h5>
                <div id="totalTickets" class="stat-value">‚Äî</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm card-hover h-100">
              <div class="card-body">
                <h5 class="card-title text-muted mb-1">Ouverts</h5>
                <div id="openTickets" class="stat-value text-primary">‚Äî</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm card-hover h-100">
              <div class="card-body">
                <h5 class="card-title text-muted mb-1">Ferm√©s</h5>
                <div id="closedTickets" class="stat-value text-success">‚Äî</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card shadow-sm card-hover h-100">
              <div class="card-body">
                <h5 class="card-title text-muted mb-1">Temps moyen de r√©solution</h5>
                <div id="avgResolution" class="stat-value text-dark">‚Äî</div>
                <div class="text-muted small" id="avgResolutionMinutesHint"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- S√©ries temporelles -->
      <section class="card shadow mb-4">
        <div class="card-body">
          <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
            <h2 class="h5 mb-0 text-primary">√âvolution des tickets</h2>
            <div class="d-flex gap-2">
              <select id="periodSelect" class="form-select form-select-sm" style="width: 160px;">
                <option value="day" selected>Par jour</option>
                <option value="week">Par semaine</option>
                <option value="month">Par mois</option>
              </select>
              <select id="limitSelect" class="form-select form-select-sm" style="width: 140px;">
                <option value="14">14</option>
                <option value="30" selected>30</option>
                <option value="60">60</option>
                <option value="90">90</option>
              </select>
              <button id="refreshBtn" class="btn btn-sm btn-outline-primary">Rafra√Æchir</button>
            </div>
          </div>
          <div class="chart-container mt-3">
            <canvas id="timeChart"></canvas>
          </div>
          <p class="text-muted small mt-2 mb-0">
            Astuce: change le ‚Äúp√©riode‚Äù pour regrouper par jour/semaine/mois.
          </p>
        </div>
      </section>

      <!-- Top utilisateurs -->
      <section class="card shadow mb-4">
        <div class="card-body">
          <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
            <h2 class="h5 mb-0 text-primary">Top utilisateurs (cr√©ation)</h2>
            <div class="d-flex gap-2">
              <select id="userTypeSelect" class="form-select form-select-sm" style="width: 180px;">
                <option value="created" selected>Cr√©ateurs de tickets</option>
                <option value="closed">Cl√¥ture de tickets</option>
              </select>
              <select id="userLimitSelect" class="form-select form-select-sm" style="width: 140px;">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
                <option value="20">20</option>
              </select>
            </div>
          </div>
          <div class="chart-container mt-3" style="height: 320px;">
            <canvas id="usersChart"></canvas>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-primary text-center text-light py-3 mt-auto">
    <p class="mb-0">&copy; 2025 Go Ticket Manager - Tous droits r√©serv√©s.</p>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const nf = new Intl.NumberFormat('fr-FR');
    const timeFmt = (mins) => {
      if (mins == null || isNaN(mins)) return '‚Äî';
      const m = Math.round(mins);
      const h = Math.floor(m / 60);
      const r = m % 60;
      if (h <= 0) return r + ' min';
      return h + ' h ' + (r ? r + ' min' : '');
    };

    async function getJSON(url) {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    // Cartes r√©sum√©
    async function loadSummary() {
      try {
        const s = await getJSON('/api/stats/summary');
        document.getElementById('totalTickets').textContent  = nf.format(s.total_tickets ?? 0);
        document.getElementById('openTickets').textContent   = nf.format(s.open_tickets ?? 0);
        document.getElementById('closedTickets').textContent = nf.format(s.closed_tickets ?? 0);
        document.getElementById('avgResolution').textContent = timeFmt(s.avg_resolution_minutes);
        document.getElementById('avgResolutionMinutesHint').textContent =
          s.avg_resolution_minutes ? '(' + nf.format(Math.round(s.avg_resolution_minutes)) + ' min)' : '';
      } catch (e) {
        console.error('summary', e);
      }
    }

    // Merge labels x (union) et aligne y
    function mergeSeries(a, b) {
      const mapA = new Map(a.map(p => [p.x, p.y]));
      const mapB = new Map(b.map(p => [p.x, p.y]));
      const labels = Array.from(new Set([...mapA.keys(), ...mapB.keys()])).sort();
      const da = labels.map(x => mapA.get(x) ?? 0);
      const db = labels.map(x => mapB.get(x) ?? 0);
      return { labels, da, db };
    }

    let timeChart, usersChart;

    // Chart s√©ries temporelles (cr√©√©s vs ferm√©s)
    async function loadTimeSeries() {
      const period = document.getElementById('periodSelect').value;
      const limit  = document.getElementById('limitSelect').value;

      try {
        const [created, closed] = await Promise.all([
          getJSON(`/api/stats/time?period=${encodeURIComponent(period)}&type=created&limit=${encodeURIComponent(limit)}`),
          getJSON(`/api/stats/time?period=${encodeURIComponent(period)}&type=closed&limit=${encodeURIComponent(limit)}`)
        ]);

        const { labels, da, db } = mergeSeries(created, closed);

        const data = {
          labels,
          datasets: [
            {
              label: 'Cr√©√©s',
              data: da,
              fill: false,
              tension: .2,
              borderWidth: 2,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13,110,253,.2)',
              pointRadius: 2
            },
            {
              label: 'Ferm√©s',
              data: db,
              fill: false,
              tension: .2,
              borderWidth: 2,
              borderColor: '#198754',
              backgroundColor: 'rgba(25,135,84,.2)',
              pointRadius: 2
            }
          ]
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${nf.format(ctx.parsed.y)}`
            } }
          },
          scales: {
            x: { ticks: { maxRotation: 0 }, grid: { display: false } },
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        };

        if (timeChart) timeChart.destroy();
        timeChart = new Chart(document.getElementById('timeChart'), { type: 'line', data, options });
      } catch (e) {
        console.error('time series', e);
      }
    }

    // Chart top users
    async function loadTopUsers() {
      const type = document.getElementById('userTypeSelect').value;
      const limit = document.getElementById('userLimitSelect').value;

      try {
        const rows = await getJSON(`/api/stats/by-user?type=${encodeURIComponent(type)}&limit=${encodeURIComponent(limit)}`);
        const labels = rows.map(r => r.name || 'unknown');
        const data = rows.map(r => r.count || 0);

        const chartData = {
          labels,
          datasets: [{
            label: type === 'created' ? 'Tickets cr√©√©s' : 'Tickets ferm√©s',
            data,
            borderWidth: 1,
            backgroundColor: labels.map(() => 'rgba(13,110,253,.6)'),
            borderColor: labels.map(() => '#0d6efd')
          }]
        };
        const options = {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: {
              label: (ctx) => nf.format(ctx.parsed.x)
            } }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } },
            y: { ticks: { autoSkip: false, maxTicksLimit: 20 } }
          }
        };

        if (usersChart) usersChart.destroy();
        usersChart = new Chart(document.getElementById('usersChart'), { type: 'bar', data: chartData, options });
      } catch (e) {
        console.error('by-user', e);
      }
    }

    // Listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadSummary();
      loadTimeSeries();
      loadTopUsers();

      document.getElementById('refreshBtn').addEventListener('click', () => loadTimeSeries());
      document.getElementById('periodSelect').addEventListener('change', () => loadTimeSeries());
      document.getElementById('limitSelect').addEventListener('change', () => loadTimeSeries());
      document.getElementById('userTypeSelect').addEventListener('change', () => loadTopUsers());
      document.getElementById('userLimitSelect').addEventListener('change', () => loadTopUsers());
    });
  </script>
</body>
</html>
